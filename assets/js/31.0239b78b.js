(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{593:function(t,s,a){"use strict";a.r(s);var n=a(17),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"rest-framework专栏讲解-十六-authentication"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rest-framework专栏讲解-十六-authentication"}},[t._v("#")]),t._v(" Rest-framework专栏讲解(十六)：Authentication")]),t._v(" "),a("p",[t._v("身份验证是将传入请求与一组标识凭据(例如, 请求来自的用户或与其进行签名的令牌)相关联的机制, 然后, 权限和限制策略可以使用这些凭据来确定是否应允许该请求。")]),t._v(" "),a("p",[t._v("注意：请求身份凭证将不会允许携带身份凭证, 只仅仅是标识发出请求的凭据信息。")]),t._v(" "),a("h3",{attrs:{id:"如何确定身份验证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如何确定身份验证"}},[t._v("#")]),t._v(" 如何确定身份验证")]),t._v(" "),a("p",[t._v("身份验证方案始终定义为类列表, RESTframework 将尝试对列表中的每个类进行身份验证, 并将设置 "),a("code",[t._v("request.user")]),t._v(" 和 "),a("code",[t._v("request.auth")]),t._v(" 为成功进行身份验证的第一个类的返回值。")]),t._v(" "),a("p",[t._v("如果没有任何类通过身份验证, "),a("code",[t._v("request.user")]),t._v(" 则将设置为 "),a("code",[t._v("django.contrib.auth.models.AnonymousUser")]),t._v(" 的实例, 并将 "),a("code",[t._v("request.auth")]),t._v(" 设置为 "),a("code",[t._v("None")]),t._v("。")]),t._v(" "),a("p",[t._v("未认证请求的 "),a("code",[t._v("request.user")]),t._v(" 和 "),a("code",[t._v("request.auth")]),t._v(" 可以使用 "),a("code",[t._v("UNAUTHENTICATED_USER")]),t._v(" 和 "),a("code",[t._v("UNAUTHENTICATED_TOKEN")]),t._v(" 设置进行修改。")]),t._v(" "),a("h3",{attrs:{id:"设置认证方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#设置认证方案"}},[t._v("#")]),t._v(" 设置认证方案")]),t._v(" "),a("p",[t._v("可以使用 "),a("code",[t._v("DEFAULT_AUTHENTICATION_CLASSES")]),t._v(" 全局设置默认身份验证方案, 例如：")]),t._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[t._v("REST_FRAMEWORK "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'DEFAULT_AUTHENTICATION_CLASSES'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'rest_framework.authentication.BasicAuthentication'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'rest_framework.authentication.SessionAuthentication'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n复制代码\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[t._v("你也可以在单独的视图中设置特殊的认证方式：")]),t._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" rest_framework"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("authentication "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" SessionAuthentication"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" BasicAuthentication\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" rest_framework"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("permissions "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" IsAuthenticated\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" rest_framework"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("response "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Response\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" rest_framework"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("views "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" APIView\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ExampleView")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("APIView"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    authentication_classes "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("SessionAuthentication"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" BasicAuthentication"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    permission_classes "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("IsAuthenticated"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("format")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        content "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'user'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("unicode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# `django.contrib.auth.User` instance.")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'auth'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("unicode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("auth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# None")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" Response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("content"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n复制代码\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br")])]),a("p",[t._v("或者是视图函数：")]),t._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@api_view")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'GET'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@authentication_classes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("SessionAuthentication"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" BasicAuthentication"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@permission_classes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("IsAuthenticated"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("example_view")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("format")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    content "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'user'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("unicode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# `django.contrib.auth.User` instance.")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'auth'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("unicode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("auth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# None")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" Response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("content"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n复制代码\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br")])]),a("h3",{attrs:{id:"错误响应"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#错误响应"}},[t._v("#")]),t._v(" 错误响应")]),t._v(" "),a("p",[t._v("当未经身份验证的请求被拒绝时, 可能会有两个不同的错误代码是合适的。")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("HTTP 401")]),t._v(" 未经授权")]),t._v(" "),a("li",[a("code",[t._v("HTTP 403")]),t._v(" 权限被拒绝")])]),t._v(" "),a("p",[a("code",[t._v("HTTP 401")]),t._v(" 响应必须始终包含 "),a("code",[t._v("WWW-Authenticate")]),t._v(" 标头, 该标头指示客户端如何进行身份验证, "),a("code",[t._v("HTTP 403")]),t._v(" 响应不包含 "),a("code",[t._v("WWW-Authenticate")]),t._v(" 标头。")]),t._v(" "),a("h3",{attrs:{id:"apache-mod-wsgi-特定配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#apache-mod-wsgi-特定配置"}},[t._v("#")]),t._v(" Apache mod_wsgi 特定配置")]),t._v(" "),a("p",[t._v("请注意, 如果使用 "),a("a",{attrs:{href:"https://modwsgi.readthedocs.io/en/develop/configuration-directives/WSGIPassAuthorization.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("mod_wsgi"),a("OutboundLink")],1),t._v(" 部署到 "),a("a",{attrs:{href:"https://modwsgi.readthedocs.io/en/develop/configuration-directives/WSGIPassAuthorization.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Apache"),a("OutboundLink")],1),t._v(", 则默认情况下不会将授权标头传递给 WSGI 应用程序, 因为假定身份验证将由 Apache 处理, 而不是在应用程序级别进行。")]),t._v(" "),a("p",[t._v("如果要部署到 Apache 并使用任何基于非会话的身份验证, 则需要显式配置 mod_wsgi 以将所需的标头传递给应用程序, 这可以通过在适当的上下文中指定指令并将 "),a("code",[t._v("WSGIPassAuthorization")]),t._v(" 设置为 "),a("code",[t._v("'On'")]),t._v(" 来完成。")]),t._v(" "),a("div",{staticClass:"language-config line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("# this can go in either server config, virtual host, directory or .htaccess\nWSGIPassAuthorization On\n复制代码\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("h3",{attrs:{id:"基本认证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基本认证"}},[t._v("#")]),t._v(" 基本认证")]),t._v(" "),a("p",[t._v("此身份验证方案使用 HTTP Basic Authentication, 该身份针对用户的用户名和密码进行了签名, 基本身份验证通常仅适用于测试, 如果成功通过 "),a("code",[t._v("BasicAuthentication")]),t._v(" 身份验证，请提供以下凭据：")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("request.user")]),t._v("： Django "),a("code",[t._v("User")]),t._v(" 类的实例对象")]),t._v(" "),a("li",[a("code",[t._v("request.auth")]),t._v("："),a("code",[t._v("None")])])]),t._v(" "),a("h3",{attrs:{id:"令牌认证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#令牌认证"}},[t._v("#")]),t._v(" 令牌认证")]),t._v(" "),a("p",[t._v("此身份验证方案使用简单的基于令牌的 HTTP 身份验证方案, 令牌认证适用于客户端-服务器设置, 例如本地台式机和移动客户端, 要使用该 "),a("code",[t._v("TokenAuthentication")]),t._v(" 方案, 您需要将身份验证类配置为内包含 "),a("code",[t._v("TokenAuthentication")]),t._v(", 并另外在您的 "),a("code",[t._v("INSTALLED_APPS")]),t._v(" 中添加设置 "),a("code",[t._v("rest_framework.authtoken")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[t._v("INSTALLED_APPS "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'rest_framework.authtoken'")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n复制代码\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[t._v("还需要为用户创建令牌：")]),t._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" rest_framework"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("authtoken"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("models "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Token\n\ntoken "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Token"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("objects"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("create"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("token"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n复制代码\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[t._v("为了使客户端进行身份验证, 令牌密钥应包含在 HTTP 标头 "),a("code",[t._v("Authorization")]),t._v(" 中, 密钥应以字符串文字 "),a("code",[t._v("Token")]),t._v(" 作为前缀, 并用空格分隔两个字符串, 例如：")]),t._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Authorization")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Token 9944b09199c62bcf9418ad846dd0e4bbdfc6ee4b\n复制代码\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("注意：如果您想在头中使用不同的关键字, 例如 "),a("code",[t._v("Bearer")]),t._v(", 只需将 "),a("code",[t._v("TokenAuthentication")]),t._v(" 子类对象并设置 "),a("code",[t._v("keyword")]),t._v(" 变量, 如果成功验证, "),a("code",[t._v("TokenAuthentication")]),t._v(" 将提供以下凭据：")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("request.user")]),t._v("： Django "),a("code",[t._v("User")]),t._v(" 类的实例对象")]),t._v(" "),a("li",[a("code",[t._v("request.auth")]),t._v("："),a("code",[t._v("rest_framework.authtoken.models.Token")]),t._v(" 的实例对象")])]),t._v(" "),a("p",[t._v("未经授权的身份认证都将会被拒绝, 返回 "),a("code",[t._v("HTTP 401 Unauthorized")]),t._v(" 的状态码, 并带有 "),a("code",[t._v("WWWW-Authenticate")]),t._v(" 的标头, 如下所示：")]),t._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("WWW-Authenticate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Token\n复制代码\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("你也可以使用 "),a("code",[t._v("curl")]),t._v(" 进行令牌身份认证测试：")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -X GET http://127.0.0.1:8000/api/example/ -H "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Authorization: Token 9944b09199c62bcf9418ad846dd0e4bbdfc6ee4b'")]),t._v("\n复制代码\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("h3",{attrs:{id:"生成令牌"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#生成令牌"}},[t._v("#")]),t._v(" 生成令牌")]),t._v(" "),a("p",[t._v("当你希望每个用户都自动生成一个令牌, 只需要捕获用户的 "),a("code",[t._v("post_save")]),t._v(" 信号即可：")]),t._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" django"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("conf "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" settings\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" django"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("models"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("signals "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" post_save\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" django"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dispatch "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" receiver\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" rest_framework"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("authtoken"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("models "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Token\n\n"),a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@receiver")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("post_save"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sender"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("settings"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AUTH_USER_MODEL"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("create_auth_token")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sender"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" instance"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" created"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("False")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("**")]),t._v("kwargs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" created"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        Token"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("objects"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("create"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n复制代码\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br")])]),a("p",[t._v("需要注意的是, 你需要将该代码片段放置在已安装的 "),a("code",[t._v("models.py")]),t._v(" 中, 或者 Django 启动后会自动加载导入的其他位置, 如果你已经创建了一些用户, 测你可以使用下面的代码片段为现有的用户生成令牌：")]),t._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" django"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("contrib"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("auth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("models "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" User\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" rest_framework"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("authtoken"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("models "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Token\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" user "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" User"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("objects"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("all")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    Token"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("objects"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_or_create"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n复制代码\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("p",[t._v("上面的方式是通过信号捕获的方式进行令牌生成的, 你可以利用 API 的方式进行令牌生成返回。")]),t._v(" "),a("p",[t._v("使用 "),a("code",[t._v("TokenAuthentication")]),t._v(", 可能希望为客户端提供一种以给定用户名和密码来获得令牌的机制, 本身框架的内置视图 "),a("code",[t._v("obtain_auth_token")]),t._v(" 视图行为就提供了这样的方法, 你只需要在 URL 配置中注册就可以使用：")]),t._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" rest_framework"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("authtoken "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" views\nurlpatterns "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'api-token-auth/'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" views"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("obtain_auth_token"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n复制代码\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[t._v("当你使用表单的方式进行认证请求令牌的时候, 如果认证成功了, 则会返回下面的 JSON 数据响应：")]),t._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"token"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"9944b09199c62bcf9418ad846dd0e4bbdfc6ee4b"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n复制代码\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("请注意, 默认 "),a("code",[t._v("obtain_auth_token")]),t._v(" 视图明确使用 JSON 请求和响应, 而不是在设置中使用默认渲染器和解析器类, 默认情况下没有权限或限制应用于 "),a("code",[t._v("obtain_auth_token")]),t._v(" 视图, 如果希望使用应用限制, 则需要重写视图类并使用 "),a("code",[t._v("throttle_classes")]),t._v(" 属性将其包括在内。")]),t._v(" "),a("p",[t._v("如果需要 "),a("code",[t._v("obtain_auth_token")]),t._v(" 视图的自定义版本, 则可以通过将 "),a("code",[t._v("ObtainAuthToken")]),t._v(" 视图类子类化, 然后在 URL 配置中使用它来实现。")]),t._v(" "),a("p",[t._v("例如你可以返回 token 值之外的其他用户信息：")]),t._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" rest_framework"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("authtoken"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("views "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" ObtainAuthToken\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" rest_framework"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("authtoken"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("models "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Token\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" rest_framework"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("response "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Response\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CustomAuthToken")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ObtainAuthToken"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("post")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("**")]),t._v("kwargs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        serializer "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" self"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("serializer_class"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                                           context"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'request'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        serializer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("is_valid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("raise_exception"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        user "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" serializer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("validated_data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'user'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n        token"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" created "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Token"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("objects"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_or_create"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" Response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'token'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" token"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'user_id'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'email'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("email\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n复制代码\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br")])]),a("p",[t._v("你也可以通过管理界面手动创建令牌, 如果你的服务系统是拥有庞大的用户群体, 建议你使用 "),a("code",[t._v("TokenAdmin")]),t._v(" 类进行 monkey 补丁的方式, 以根据你的实际的需要定制它, 更具体地说通过将 "),a("code",[t._v("user")]),t._v(" 字段声明为 "),a("code",[t._v("raw_fied")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("# app/admin.py\n\nTokenAdmin.raw_id_fields = ['user']\n复制代码\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("h3",{attrs:{id:"django-manage-生成令牌"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#django-manage-生成令牌"}},[t._v("#")]),t._v(" Django Manage 生成令牌")]),t._v(" "),a("p",[t._v("在 "),a("code",[t._v("v3.6.4")]),t._v(" 版本开始, 可以使用 Django 命令的方式生成令牌：")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("./manage.py drf_create_token "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("username"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n复制代码\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("使用命令后将会返回给指定用户的 API 令牌数据, 如果不存在, 则会创建：")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("Generated token 9944b09199c62bcf9418ad846dd0e4bbdfc6ee4b for user user1\n复制代码\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("如果你想重新生成一个令牌, 如令牌已过期, 被破坏, 则只需要增加一个可选参数 "),a("code",[t._v("-r")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("./manage.py drf_create_token -r "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("username"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n复制代码\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("h3",{attrs:{id:"session-认证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#session-认证"}},[t._v("#")]),t._v(" Session 认证")]),t._v(" "),a("p",[t._v("这种身份认证方案使用的 Django 的默认后端 Session 身份认证, 适用于网站相同上下文中运行的 AJAX 客户端请求, 如果通过身份认证, "),a("code",[t._v("SessionAuthentication")]),t._v(" 将会提供以下凭证属性：")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("request.user")]),t._v(" 认证用户的 User 实例")]),t._v(" "),a("li",[a("code",[t._v("request.auth")]),t._v(" 等于 "),a("code",[t._v("None")])])]),t._v(" "),a("p",[t._v("未经授权的未认证身份将会返回 "),a("code",[t._v("HTTP 403 Forbidden")]),t._v(" 状态。")]),t._v(" "),a("p",[t._v("如果您使用的是带有 "),a("code",[t._v("SessionAuthentication")]),t._v(' 的 AJAX 风格的 API, 你需要确保你的令牌包含任何 "unsafe" 的 HTTP 方法调用一个有效的 CSRF, 如 PUT、PATCH、POST 或 DELETE 请求。有关更多详细信息，请参见 '),a("a",{attrs:{href:"https://docs.djangoproject.com/en/stable/ref/csrf/#ajax",target:"_blank",rel:"noopener noreferrer"}},[t._v("Django CSRF"),a("OutboundLink")],1),t._v(" 文档。")]),t._v(" "),a("p",[t._v("警告：创建登录页面时, 请始终使用 Django 的标准登录视图, 这将确保您的登录视图受到适当的保护。")]),t._v(" "),a("p",[t._v("框架中的 CSRF 验证与标准 Django 的工作原理略有不同, 这是因为需要对同一视图同时支持基于会话和基于非会话的身份验证, 这意味着只有经过身份验证的请求才需要 CSRF 令牌, 并且匿名请求可能没有 CSRF 令牌就可以发送, 此行为不适用于应始终应用 CSRF 验证的登录视图。")]),t._v(" "),a("h3",{attrs:{id:"远程用户认证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#远程用户认证"}},[t._v("#")]),t._v(" 远程用户认证")]),t._v(" "),a("p",[t._v("通过此身份验证方案, 您可以将身份验证委派给 Web 服务器, 该服务器设置 "),a("code",[t._v("REMOTE_USER")]),t._v(" 环境变量。")]),t._v(" "),a("p",[t._v("要使用它, 必须在 "),a("code",[t._v("AUTHENTICATION_BACKENDS")]),t._v(" 中设置 "),a("code",[t._v("django.contrib.auth.backends.RemoteUserBackend")]),t._v(" (或子类), 默认情况下 "),a("code",[t._v("RemoteUserBackend")]),t._v(" 为尚不存在的用户名创建 "),a("code",[t._v("User")]),t._v(" 对象, 要更改此行为和其他行为，请参阅 "),a("a",{attrs:{href:"https://docs.djangoproject.com/en/stable/howto/auth-remote-user/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Django"),a("OutboundLink")],1),t._v(" 文档。")]),t._v(" "),a("p",[t._v("如果成功通过身份验证，"),a("code",[t._v("RemoteUserAuthentication")]),t._v(" 会提供以下凭据：")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("request.user")]),t._v(" 将是 Django "),a("code",[t._v("User")]),t._v(" 实例")]),t._v(" "),a("li",[a("code",[t._v("request.auth")]),t._v(" 将会 "),a("code",[t._v("None")])])]),t._v(" "),a("p",[t._v("有关配置身份验证方法的信息请查阅 Web 服务器的文档, 例如：")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://httpd.apache.org/docs/2.4/howto/auth.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Apache Authentication How-To"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://docs.nginx.com/nginx/admin-guide/security-controls/configuring-http-basic-authentication/",target:"_blank",rel:"noopener noreferrer"}},[t._v("NGINX (Restricting Access)"),a("OutboundLink")],1)])]),t._v(" "),a("h3",{attrs:{id:"自定义认证方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#自定义认证方式"}},[t._v("#")]),t._v(" 自定义认证方式")]),t._v(" "),a("p",[t._v("要实现自定义身份验证方案, 请继承 "),a("code",[t._v("BaseAuthentication")]),t._v(" 并重写该 "),a("code",[t._v(".authenticate(self, request)")]),t._v(" 方法, 如果身份验证成功则会返回一个元组数据 "),a("code",[t._v("(user, auth)")]),t._v(", 否则则会返回 "),a("code",[t._v("None")]),t._v("。")]),t._v(" "),a("p",[t._v("在某些情况下 "),a("code",[t._v("None")]),t._v(", 可能是 "),a("code",[t._v("AuthenticationFailed")]),t._v(" 中 "),a("code",[t._v(".authenticate()")]),t._v(" 方法中引发的异常, 而不是返回。")]),t._v(" "),a("p",[t._v("通常，您应该采用的方法是：")]),t._v(" "),a("p",[t._v("如果未尝试认证请返回 "),a("code",[t._v("None")]),t._v(", 还在使用的任何其他身份验证方案仍将被检查。 如果尝试进行身份验证但失败，请引发 "),a("code",[t._v("AuthenticationFailed")]),t._v(" 异常, 不管是否进行任何权限检查, 并且不检查任何其他身份验证方案, 都将立即返回错误响应。 您也可以覆盖该 "),a("code",[t._v(".authenticate_header(self, request)")]),t._v(" 方法, 如果实现, 则应返回一个字符串, 该字符串将用作 "),a("code",[t._v("HTTP 401 Unauthorized")]),t._v(" 响应中 "),a("code",[t._v("WWW-Authenticate")]),t._v(" 标头的值。")]),t._v(" "),a("p",[t._v("如果 "),a("code",[t._v(".authenticate_header()")]),t._v(" 未重写该方法, 则当未认证的请求被拒绝访问时认证方案将返回 "),a("code",[t._v("HTTP 403 Forbidden")]),t._v(" 响应。")]),t._v(" "),a("p",[t._v("注意：当请求对象的 "),a("code",[t._v(".user")]),t._v(" 或 "),a("code",[t._v(".auth")]),t._v(" 属性调用自定义身份验证器时, 您可能会看到 "),a("code",[t._v("AttributeError")]),t._v(" 重新引发为 "),a("code",[t._v("WrappedAttributeError")]),t._v(", 这对于防止原始异常被外部属性访问抑制是必要的。Python 不会识别该 "),a("code",[t._v("AttributeError")]),t._v(" 来源源自您的自定义身份验证器, 而是假设该请求对象没有 "),a("code",[t._v(".user")]),t._v(" 或 "),a("code",[t._v(".auth")]),t._v(" 属性。这些错误应由验证者修复或以其他方式处理。")]),t._v(" "),a("p",[t._v("例如以下示例将对名为 "),a("code",[t._v("X-USERNAME")]),t._v(" 的自定义请求标头中的用户名所指定的用户身份进行身份验证：")]),t._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" django"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("contrib"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("auth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("models "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" User\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" rest_framework "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" authentication\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" rest_framework "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" exceptions\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ExampleAuthentication")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("authentication"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("BaseAuthentication"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("authenticate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        username "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("META"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'HTTP_X_USERNAME'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("not")]),t._v(" username"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            user "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" User"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("objects"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("username"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("username"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("except")]),t._v(" User"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DoesNotExist"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("raise")]),t._v(" exceptions"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AuthenticationFailed"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'No such user'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br")])])])}),[],!1,null,null,null);s.default=e.exports}}]);